<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ã‚¦ãƒå¨˜ å› å­å‘¨å›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        :root {
            --muted: #666;
            --blue-bg: #e8f4fd;
            --red-bg: #fde8ec;
            --green-bg: #e8fdee;
            --white-bg: #fffbe8;
            --card-pad: 14px;
            --gap: 16px;
            --radius: 10px;
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial;
            padding: 20px;
            max-width: 1200px;
            margin: auto;
            color: #111;
            background: #fbfcff;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 10px;
        }

        .card {
            border: 1px solid #e6e6ef;
            background: white;
            padding: var(--card-pad);
            border-radius: var(--radius);
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(16, 24, 40, 0.03);
        }

        #blueCard {
            background: var(--blue-bg);
        }

        #redCard {
            background: var(--red-bg);
        }

        #greenCard {
            background: var(--green-bg);
        }

        #whiteCard {
            background: var(--white-bg);
        }

        h3 {
            margin: 0 0 10px 0;
            padding-bottom: 6px;
            font-size: 1.05rem;
            font-weight: 700;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .row {
            display: flex;
            gap: var(--gap);
            align-items: center;
            flex-wrap: wrap;
        }

        .grid5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        label {
            display: block;
            font-size: 0.95rem;
        }

        input[type=number],
        select,
        input[type=text],
        input[type=date] {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #cfcfe6;
            width: 100%;
            box-sizing: border-box;
            background: white;
        }

        .smallInput {
            width: 120px;
        }

        .smallSelect {
            width: 140px;
        }

        .statSelect {
            width: 140px;
            margin-left: 8px;
        }

        .starSelect {
            width: 120px;
            margin-left: 8px;
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            background: #0366d6;
            color: white;
            cursor: pointer;
        }

        .muted {
            color: var(--muted);
            font-size: 0.9rem;
        }

        pre {
            background: #f6f7fb;
            padding: 10px;
            border-radius: 6px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .disabled {
            opacity: 0.45;
            pointer-events: none;
        }

        .toggleRow {
            gap: 24px;
            padding: 6px 0;
        }

        .whiteRow {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .whiteRow>* {
            font-size: 0.95rem;
        }

        .smallBtn {
            padding: 6px 8px;
            border-radius: 6px;
            background: #e6e6ef;
            color: #111;
            border: none;
            cursor: pointer;
        }

        .removeBtn {
            background: #ff6b6b;
            color: white;
            border-radius: 6px;
            padding: 4px 8px;
            border: 0;
            cursor: pointer;
        }

        .sectionTitleRow {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width:800px) {
            .grid5 {
                grid-template-columns: repeat(2, 1fr);
            }

            .statSelect {
                width: 100%;
                margin-left: 0;
            }
        }
    </style>
</head>

<body>
    <h1>ã‚¦ãƒå¨˜ å› å­å‘¨å›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p class="muted">é’ãƒ»èµ¤ãƒ»ç·‘ãƒ»ç™½(ã‚¹ã‚­ãƒ«/ãƒ¬ãƒ¼ã‚¹)ãƒ»ç™½(éºä¼å­)ã®åŒæ™‚æˆç«‹ç¢ºç‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>

    <div class="card">
        <h3>å…±é€šè¨­å®š</h3>
        <div class="row">
            <label>1æ—¥ã«å¯èƒ½ãªè‚²æˆå›æ•°
                <input id="numPerDay" type="number" value="10" min="1" max="50" class="smallInput"
                    style="margin-left:8px">
            </label>

            <label>å†æŠ½é¸å›æ•°(1ã€œ4)
                <input id="numRerolls" type="number" value="3" min="1" max="4" class="smallInput"
                    style="margin-left:8px">
            </label>

            <label>ç›®æ¨™å› å­ã‚’å¾—ã‚‰ã‚Œã‚‹æœŸå¾…å€¤(%)
                <input id="targetProb" type="number" value="90" min="1" max="99" class="smallInput"
                    style="margin-left:8px">
            </label>

            <label style="margin-left:8px">ã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆ
                <input id="deadlineDate" type="date" style="margin-left:8px" class="smallInput">
            </label>

            <label style="margin-left:8px">å› å­æŒ‡å®šãƒ‘ã‚¹
                <select id="pathType" class="smallSelect" style="margin-left:8px">
                    <option value="none">æŒ‡å®šã—ãªã„</option>
                    <option value="blue">é’ã‚’å›ºå®š</option>
                    <option value="red">èµ¤ã‚’å›ºå®š</option>
                </select>
            </label>
        </div>
    </div>

    <div class="card">
        <h3>ã©ã®å› å­ã‚’è¨ˆç®—ã«å«ã‚ã‚‹ã‹</h3>
        <div class="row toggleRow">
            <label><input type="checkbox" id="enableBlue" checked> é’å› å­</label>
            <label><input type="checkbox" id="enableRed" checked> èµ¤å› å­</label>
            <label><input type="checkbox" id="enableGreen" checked> ç·‘å› å­</label>
            <label><input type="checkbox" id="enableWhite" checked> ç™½å› å­</label>
        </div>
        <p class="muted">ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨è©²å½“å› å­ã¯å…¥åŠ›ä¸å¯(ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ)ã«ãªã‚Šã¾ã™ã€‚</p>
    </div>

    <!-- BLUE -->
    <div class="card" id="blueCard">
        <h3 id="blueTitle">é’å› å­(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)</h3>
        <div class="grid5">
            <div><label>ã‚¹ãƒ”ãƒ¼ãƒ‰
                    <select id="speedRank" class="statSelect">
                        <option value="belowB">ï½599 / ï½C+</option>
                        <option value="BtoS">600ï½1099 / Bï½S+</option>
                        <option value="SS" selected>1100ï½ / SSï½</option>
                    </select>
                </label></div>

            <div><label>ã‚¹ã‚¿ãƒŸãƒŠ
                    <select id="staminaRank" class="statSelect">
                        <option value="belowB">ï½599 / ï½C+</option>
                        <option value="BtoS">600ï½1099 / Bï½S+</option>
                        <option value="SS" selected>1100ï½ / SSï½</option>
                    </select>
                </label></div>

            <div><label>ãƒ‘ãƒ¯ãƒ¼
                    <select id="powerRank" class="statSelect">
                        <option value="belowB">ï½599 / ï½C+</option>
                        <option value="BtoS">600ï½1099 / Bï½S+</option>
                        <option value="SS" selected>1100ï½ / SSï½</option>
                    </select>
                </label></div>

            <div><label>æ ¹æ€§
                    <select id="gutsRank" class="statSelect">
                        <option value="belowB">ï½599 / ï½C+</option>
                        <option value="BtoS">600ï½1099 / Bï½S+</option>
                        <option value="SS" selected>1100ï½ / SSï½</option>
                    </select>
                </label></div>

            <div><label>è³¢ã•
                    <select id="iqRank" class="statSelect">
                        <option value="belowB">ï½599 / ï½C+</option>
                        <option value="BtoS">600ï½1099 / Bï½S+</option>
                        <option value="SS" selected>1100ï½ / SSï½</option>
                    </select>
                </label></div>
        </div>

        <div class="row" style="margin-top:10px">
            <label>ç‹™ã„ã®å› å­
                <select id="fixBlue" class="smallSelect" style="margin-left:8px;width:180px">
                    <option value="none">å›ºå®šã—ãªã„(ç­‰ç¢ºç‡)</option>
                    <option value="speed">ã‚¹ãƒ”ãƒ¼ãƒ‰</option>
                    <option value="stamina">ã‚¹ã‚¿ãƒŸãƒŠ</option>
                    <option value="power">ãƒ‘ãƒ¯ãƒ¼</option>
                    <option value="guts">æ ¹æ€§</option>
                    <option value="iq">è³¢ã•</option>
                </select>
            </label>

            <label style="margin-left:12px">æ˜Ÿæ¡ä»¶
                <select id="starGoalBlue" class="starSelect" style="margin-left:8px">
                    <option value="ge1">æŒ‡å®šã—ãªã„</option>
                    <option value="ge2">â˜…2ä»¥ä¸Š</option>
                    <option value="only1">â˜…1ã®ã¿</option>
                    <option value="only2">â˜…2ã®ã¿</option>
                    <option value="only3" selected>â˜…3ã®ã¿</option>
                </select>
            </label>
        </div>
        <p class="muted">é’å› å­ã®æ˜Ÿåˆ†å¸ƒã¯3ã¤ã®åŒºåˆ†ï¼ˆï½599 / 600ï½1099 / 1100ï½ï¼‰ã§åˆ¤å®š</p>
    </div>

    <!-- RED -->
    <div class="card" id="redCard">
        <h3 id="redTitle">èµ¤å› å­(é©æ€§)</h3>
        <div class="row">
            <label>ç‹™ã„ã®å› å­
                <select id="redTarget" style="margin-left:8px">
                    <option value="èŠ" selected>èŠ</option>
                    <option value="ãƒ€ãƒ¼ãƒˆ">ãƒ€ãƒ¼ãƒˆ</option>
                    <option value="çŸ­è·é›¢">çŸ­è·é›¢</option>
                    <option value="ãƒã‚¤ãƒ«">ãƒã‚¤ãƒ«</option>
                    <option value="ä¸­è·é›¢">ä¸­è·é›¢</option>
                    <option value="é•·è·é›¢">é•·è·é›¢</option>
                    <option value="é€ƒã’">é€ƒã’</option>
                    <option value="å…ˆè¡Œ">å…ˆè¡Œ</option>
                    <option value="å·®ã—">å·®ã—</option>
                    <option value="è¿½è¾¼">è¿½è¾¼</option>
                </select>
            </label>

            <label style="margin-left:12px">èµ¤å› å­ã®å€™è£œæ•°(3ã€œ10)
                <input id="numSuitable" type="number" min="3" max="10" value="5" style="width:84px;margin-left:8px">
            </label>

            <label style="margin-left:12px">æ˜Ÿæ¡ä»¶
                <select id="starGoalRed" class="starSelect" style="margin-left:8px">
                    <option value="ge1">æŒ‡å®šã—ãªã„</option>
                    <option value="ge2">â˜…2ä»¥ä¸Š</option>
                    <option value="only1">â˜…1ã®ã¿</option>
                    <option value="only2">â˜…2ã®ã¿</option>
                    <option value="only3" selected>â˜…3ã®ã¿</option>
                </select>
            </label>
        </div>
        <p class="muted">èµ¤å› å­ã®æ˜Ÿåˆ†å¸ƒã¯å›ºå®š â˜…1=20% / â˜…2=70% / â˜…3=10%</p>
    </div>

    <!-- GREEN -->
    <div class="card" id="greenCard">
        <h3>ç·‘å› å­(å›ºæœ‰)</h3>
        <div class="row">
            <label>æ˜Ÿæ¡ä»¶
                <select id="starGoalGreen" class="starSelect" style="margin-left:8px">
                    <option value="ge1">æŒ‡å®šã—ãªã„</option>
                    <option value="ge2">â˜…2ä»¥ä¸Š</option>
                    <option value="only1">â˜…1ã®ã¿</option>
                    <option value="only2">â˜…2ã®ã¿</option>
                    <option value="only3" selected>â˜…3ã®ã¿</option>
                </select>
            </label>
            <label style="margin-left:12px" class="muted">æ˜Ÿåˆ†å¸ƒã¯SSä»¥ä¸Šã®è‚²æˆãƒ©ãƒ³ã‚¯ã§å›ºå®š â˜…1=20% / â˜…2=70% / â˜…3=10%</label>
        </div>
    </div>

    <!-- WHITE -->
    <div class="card" id="whiteCard">
        <h3>ç™½å› å­</h3>

        <div style="margin-bottom:8px" class="sectionTitleRow">
            <div>
                <strong>ç™½å› å­(ã‚¹ã‚­ãƒ«/ãƒ¬ãƒ¼ã‚¹)</strong>
                <p class="muted" style="margin-top:8px">ç™½å› å­ä»˜ä¸ãƒ¢ãƒ‡ãƒ«ï¼ˆã‚¹ã‚­ãƒ«/ãƒ¬ãƒ¼ã‚¹ï¼‰ï¼šåŸºç¤ç¢ºç‡(é€šå¸¸20% / â—25% / é‡‘40%) Ã— 1.1^(è¦ª+ç¥–)
                    ã‚’ç®—å‡ºã€‚æ˜Ÿæ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿(æ˜Ÿåˆ†å¸ƒã¨ã®ä¹—ç®—)ã€‚</p>
                <label>è©•ä¾¡ãƒ©ãƒ³ã‚¯(æ˜Ÿåˆ†å¸ƒ)
                    <select id="whiteRank" class="smallSelect" style="margin-left:8px;width:260px">
                        <option value="Splus">S+ä»¥ä¸‹ (â˜…1:50% â˜…2:45% â˜…3:5%)</option>
                        <option value="SS">SSä»¥ä¸Š (â˜…1:20% â˜…2:70% â˜…3:10%)</option>
                        <option value="UE" selected>UEä»¥ä¸Š (â˜…1:18% â˜…2:70% â˜…3:12%)</option>
                    </select>
                </label>
            </div>
        </div>
        <div id="whiteSkillContainer"></div>
        <div style="margin-top:8px">
            <button id="addWhiteSkillBtn">ï¼‹è¿½åŠ ï¼ˆã‚¹ã‚­ãƒ«/ãƒ¬ãƒ¼ã‚¹ï¼‰</button>
        </div>

        <hr style="margin:12px 0">

        <div style="margin-bottom:8px" class="sectionTitleRow">
            <strong>ç™½å› å­(éºä¼å­)</strong>
        </div>
        <div>
            <p class="muted" style="margin-top:8px">èµ¤å› å­åˆè¨ˆã”ã¨ã®ç¢ºç‡: 0ï½5å€‹â†’0% / 6ï½11å€‹â†’40% / 12ï½18å€‹â†’100%ã€‚æ˜Ÿåˆ†å¸ƒã¯èµ¤å› å­ã¨åŒã˜ã¨ä»®å®š
                â˜…1=20% / â˜…2=70% / â˜…3=10%</p>
        </div>
        <div id="whiteGeneContainer"></div>
        <div style="margin-top:8px">
            <button id="addWhiteGeneBtn">ï¼‹è¿½åŠ ï¼ˆéºä¼å­ï¼‰</button>
        </div>

    </div>

    <div style="text-align:right;margin-top:10px"><button id="compute">è¨ˆç®—(å…¨ã¦åŒæ™‚ã«æˆç«‹ã™ã‚‹ç¢ºç‡)</button></div>

    <div class="card" id="resultCard" style="display:none;margin-top:12px">
        <h3>çµæœ(åŒæ™‚æˆç«‹)</h3>
        <pre id="resultText"></pre>
    </div>

    <div class="card" style="margin-top:20px">
        <h3>å‚è€ƒæ–‡çŒ®</h3>
        <ul style="margin:0;padding-left:20px">
            <li><a href="https://umamusustation.com/blue_factor_analysis.html" target="_blank"
                    rel="noopener">é’å› å­ç¢ºç‡åˆ†æ</a></li>
            <li><a href="https://aoneko-uma.fanbox.cc/posts/4359075" target="_blank"
                    rel="noopener">ã€ä¸­é–“ã¾ã¨ã‚ã€‘è‚²æˆã«ãŠã‘ã‚‹å› å­ç¶™æ‰¿å†…å®¹ã¾ã¨ã‚</a></li>
        </ul>
    </div>

    <script>
        /* =========================
           åˆ†å¸ƒãƒ‡ãƒ¼ã‚¿(æ—¢å­˜)
           ========================= */
        const blueStarDistByRank = {
            'belowB': [0.90, 0.10, 0.00],
            'BtoS': [0.495, 0.445, 0.06],
            'SS': [0.20, 0.70, 0.10]
        };

        const redStarDist = [0.20, 0.70, 0.10];
        const greenStarDist = [0.20, 0.70, 0.10];
        const whiteStarDistSets = {
            'Splus': [0.50, 0.45, 0.05],
            'SS': [0.20, 0.70, 0.10],
            'UE': [0.18, 0.70, 0.12]
        };

        function probFromCond(dist, cond) {
            if (!dist) return 0;
            if (cond === 'ge1') return dist[0] + dist[1] + dist[2];
            if (cond === 'ge2') return dist[1] + dist[2];
            if (cond === 'only3') return dist[2];
            if (cond === 'only1') return dist[0];
            if (cond === 'only2') return dist[1];
            return 0;
        }

        /* =========================
           ç™½å› å­å‹•çš„è¡Œä½œæˆï¼ˆä¿®æ­£ç‰ˆï¼‰
           ========================= */
        const MAX_SKILLS = 10;
        const MAX_GENES = 3;
        const STORAGE_KEY = 'umaToolData_v3';

        function createSkillRow(data) {
            const div = document.createElement('div');
            div.className = 'whiteRow skillRow';
            div.innerHTML = `
                <label>åŸºç¤ç¢ºç‡:
                  <select class="whiteBase" style="margin-left:6px;width:120px">
                    <option value="0.20">é€šå¸¸ (20%)</option>
                    <option value="0.25">â— (25%)</option>
                    <option value="0.40">é‡‘ (40%)</option>
                  </select>
                </label>
                <label>è¦ª+ç¥–ã®åˆè¨ˆ:
                  <input type="number" min="0" max="6" value="0" class="whiteTotal" style="width:80px;margin-left:6px">
                </label>
                <label>æ˜Ÿæ¡ä»¶:
                  <select class="whiteStarCond" style="margin-left:6px;width:140px">
                    <option value="ge1">è‡ªç”±</option>
                    <option value="ge2">â˜…2ä»¥ä¸Š</option>
                    <option value="only1">â˜…1ã®ã¿</option>
                    <option value="only2">â˜…2ã®ã¿</option>
                    <option value="only3">â˜…3ã®ã¿</option>
                  </select>
                </label>
                <button class="removeBtn" type="button">âœ•</button>
            `;
            if (data) {
                if (data.base) div.querySelector('.whiteBase').value = data.base;
                if (typeof data.total !== 'undefined') div.querySelector('.whiteTotal').value = data.total;
                if (data.star) div.querySelector('.whiteStarCond').value = data.star;
            }
            // attach change handlers
            const inputs = div.querySelectorAll('.whiteBase, .whiteTotal, .whiteStarCond');
            inputs.forEach(el => {
                el.addEventListener('change', saveInputsToStorage);
                el.addEventListener('input', saveInputsToStorage);
            });
            // remove handler
            div.querySelector('.removeBtn').addEventListener('click', () => {
                div.remove();
                saveInputsToStorage();
                updateAddButtonsState();
            });
            return div;
        }

        function createGeneRow(data) {
            const div = document.createElement('div');
            div.className = 'whiteRow geneRow';
            div.innerHTML = `
                <label>å¯¾è±¡èµ¤å› å­:
                  <select class="whiteGeneTarget" style="margin-left:6px;width:120px">
                    <option value="èŠ">èŠ</option>
                    <option value="ãƒ€ãƒ¼ãƒˆ">ãƒ€ãƒ¼ãƒˆ</option>
                    <option value="çŸ­è·é›¢">çŸ­è·é›¢</option>
                    <option value="ãƒã‚¤ãƒ«">ãƒã‚¤ãƒ«</option>
                    <option value="ä¸­è·é›¢">ä¸­è·é›¢</option>
                    <option value="é•·è·é›¢">é•·è·é›¢</option>
                    <option value="é€ƒã’">é€ƒã’</option>
                    <option value="å…ˆè¡Œ">å…ˆè¡Œ</option>
                    <option value="å·®ã—">å·®ã—</option>
                    <option value="è¿½è¾¼">è¿½è¾¼</option>
                  </select>
                </label>
                <label>èµ¤å› å­åˆè¨ˆ:
                  <select class="whiteGeneSum" style="margin-left:6px;width:120px">
                    <option value="0-5">0ã€œ5å€‹</option>
                    <option value="6-11">6ã€œ11å€‹</option>
                    <option value="12-18">12ã€œ18å€‹</option>
                  </select>
                </label>
                <label>æ˜Ÿæ¡ä»¶:
                  <select class="whiteGeneStarCond" style="margin-left:6px;width:140px">
                    <option value="ge1">è‡ªç”±</option>
                    <option value="ge2">â˜…2ä»¥ä¸Š</option>
                    <option value="only1">â˜…1ã®ã¿</option>
                    <option value="only2">â˜…2ã®ã¿</option>
                    <option value="only3">â˜…3ã®ã¿</option>
                  </select>
                </label>
                <button class="removeBtn" type="button">âœ•</button>
            `;
            if (data) {
                if (data.target) div.querySelector('.whiteGeneTarget').value = data.target;
                if (data.sum) div.querySelector('.whiteGeneSum').value = data.sum;
                if (data.star) div.querySelector('.whiteGeneStarCond').value = data.star;
            }
            const inputs = div.querySelectorAll('.whiteGeneTarget, .whiteGeneSum, .whiteGeneStarCond');
            inputs.forEach(el => {
                el.addEventListener('change', saveInputsToStorage);
                el.addEventListener('input', saveInputsToStorage);
            });
            div.querySelector('.removeBtn').addEventListener('click', () => {
                div.remove();
                saveInputsToStorage();
                updateAddButtonsState();
            });
            return div;
        }

        function updateAddButtonsState() {
            const skillCount = document.getElementById('whiteSkillContainer').querySelectorAll('.skillRow').length;
            const geneCount = document.getElementById('whiteGeneContainer').querySelectorAll('.geneRow').length;
            document.getElementById('addWhiteSkillBtn').disabled = skillCount >= MAX_SKILLS;
            document.getElementById('addWhiteGeneBtn').disabled = geneCount >= MAX_GENES;
        }

        function addWhiteSkillRow(data) {
            const container = document.getElementById('whiteSkillContainer');
            const current = container.querySelectorAll('.skillRow').length;
            if (current >= MAX_SKILLS) return;
            const row = createSkillRow(data || {});
            container.appendChild(row);
            saveInputsToStorage();
            updateAddButtonsState();
        }

        function addWhiteGeneRow(data) {
            const container = document.getElementById('whiteGeneContainer');
            const current = container.querySelectorAll('.geneRow').length;
            if (current >= MAX_GENES) return;
            const row = createGeneRow(data || {});
            container.appendChild(row);
            saveInputsToStorage();
            updateAddButtonsState();
        }

        /* =========================
           localStorage ä¿å­˜/å¾©å…ƒï¼ˆæ‹¡å¼µï¼‰
           ========================= */
        function saveInputsToStorage() {
            try {
                const all = {};
                const els = document.querySelectorAll('input[id], select[id], textarea[id]');
                els.forEach(el => {
                    if (el.type === 'checkbox') all[el.id] = el.checked;
                    else all[el.id] = el.value;
                });

                // ç™½(ã‚¹ã‚­ãƒ«/ãƒ¬ãƒ¼ã‚¹)
                all['_whiteBases'] = Array.from(document.getElementsByClassName('whiteBase')).map(e => e.value);
                all['_whiteTotals'] = Array.from(document.getElementsByClassName('whiteTotal')).map(e => e.value);
                all['_whiteStars'] = Array.from(document.getElementsByClassName('whiteStarCond')).map(e => e.value);

                // ç™½(éºä¼å­)
                all['_whiteGeneTargets'] = Array.from(document.getElementsByClassName('whiteGeneTarget')).map(e => e.value);
                all['_whiteGeneSums'] = Array.from(document.getElementsByClassName('whiteGeneSum')).map(e => e.value);
                all['_whiteGeneStars'] = Array.from(document.getElementsByClassName('whiteGeneStarCond')).map(e => e.value);

                localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
            } catch (e) {
                console.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
            }
        }

        function loadInputsFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return null;
                const data = JSON.parse(raw);
                Object.keys(data).forEach(key => {
                    if (key.startsWith('_')) return;
                    const el = document.getElementById(key);
                    if (!el) return;
                    if (el.type === 'checkbox') el.checked = !!data[key];
                    else el.value = data[key];
                });
                return data;
            } catch (e) {
                console.error('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
                return null;
            }
        }

        function restoreDynamicWhiteFromStorage(data) {
            const skillContainer = document.getElementById('whiteSkillContainer');
            const geneContainer = document.getElementById('whiteGeneContainer');
            skillContainer.innerHTML = '';
            geneContainer.innerHTML = '';

            const bases = (data && data['_whiteBases']) || [];
            const totals = (data && data['_whiteTotals']) || [];
            const stars = (data && data['_whiteStars']) || [];

            const gTargets = (data && data['_whiteGeneTargets']) || [];
            const gSums = (data && data['_whiteGeneSums']) || [];
            const gStars = (data && data['_whiteGeneStars']) || [];

            // restore skills; if none, create default 1 (ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º)
            if (bases.length === 0) {
                addWhiteSkillRow();
            } else {
                for (let i = 0; i < bases.length; i++) {
                    addWhiteSkillRow({
                        base: bases[i],
                        total: totals[i] || 0,
                        star: stars[i] || 'ge1'
                    });
                }
            }

            // restore genes; if none, create default 1 (ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º)
            if (gTargets.length === 0) {
                addWhiteGeneRow();
            } else {
                for (let i = 0; i < gTargets.length && i < MAX_GENES; i++) {
                    addWhiteGeneRow({
                        target: gTargets[i],
                        sum: gSums[i] || '0-5',
                        star: gStars[i] || 'ge1'
                    });
                }
            }

            updateAddButtonsState();
        }

        /* =========================
           è¨ˆç®—å‡¦ç†ï¼ˆp_joint ã¨æ—¥æ•°/æœŸé™ç¢ºç‡ï¼‰
           ========================= */
        function computeHandler() {
            const D = Math.max(1, parseInt(document.getElementById('numPerDay').value || 1, 10));
            const r = Math.min(3, Math.max(1, parseInt(document.getElementById('numRerolls').value || 1, 10)));
            const trialsPerDay = D * r;
            const T = Math.min(0.999999, (parseFloat(document.getElementById('targetProb').value) || 90) / 100);
            const path = document.getElementById('pathType').value;

            const enableBlue = document.getElementById('enableBlue').checked;
            const enableRed = document.getElementById('enableRed').checked;
            const enableGreen = document.getElementById('enableGreen').checked;
            const enableWhite = document.getElementById('enableWhite').checked;

            let p_blue = 1.0, p_red = 1.0, p_green = 1.0, p_white_skill = 1.0, p_white_gene = 1.0;

            /* ----- BLUE ----- */
            if (enableBlue) {
                const fix = document.getElementById('fixBlue').value; // none|speed|stamina|power|guts|iq
                const starGoal = document.getElementById('starGoalBlue').value;
                const keys = ['speed', 'stamina', 'power', 'guts', 'iq'];

                if (fix !== 'none') {
                    const selectId = (fix === 'iq' ? 'iqRank' : fix + 'Rank');
                    const rankKey = document.getElementById(selectId).value; // now 'belowB'|'BtoS'|'SS'
                    const dist = blueStarDistByRank[rankKey];
                    const pStar = probFromCond(dist, starGoal);
                    const selProb = (path === 'blue') ? 1.0 : (1.0 / 5.0);
                    p_blue = selProb * pStar;
                } else {
                    p_blue = 0;
                    keys.forEach(k => {
                        const selectId = k + 'Rank';
                        const rankKey = document.getElementById(selectId).value; // 'belowB'|'BtoS'|'SS'
                        const dist = blueStarDistByRank[rankKey];
                        const pStar = probFromCond(dist, starGoal);
                        p_blue += (1.0 / 5.0) * pStar;
                    });
                }
            }

            /* ----- RED ----- */
            if (enableRed) {
                const m = Math.min(10, Math.max(3, parseInt(document.getElementById('numSuitable').value || 3, 10)));
                const starGoal = document.getElementById('starGoalRed').value;
                const pStar = probFromCond(redStarDist, starGoal);
                if (path === 'red') {
                    p_red = pStar;
                } else {
                    p_red = (1.0 / m) * pStar;
                }
            }

            /* ----- GREEN ----- */
            if (enableGreen) {
                const starGoal = document.getElementById('starGoalGreen').value;
                p_green = probFromCond(greenStarDist, starGoal);
            }

            /* ----- WHITE (ã‚¹ã‚­ãƒ«/ãƒ¬ãƒ¼ã‚¹) ----- */
            if (enableWhite) {
                const skillBaseEls = Array.from(document.getElementsByClassName('whiteBase'));
                const totalEls = Array.from(document.getElementsByClassName('whiteTotal'));
                const starEls = Array.from(document.getElementsByClassName('whiteStarCond'));
                const k = skillBaseEls.length;
                const rankKey = document.getElementById('whiteRank').value;
                const dist = whiteStarDistSets[rankKey];

                p_white_skill = 1.0;
                for (let i = 0; i < k; i++) {
                    const baseAttach = parseFloat((skillBaseEls[i] && skillBaseEls[i].value) || '0.20');
                    const tot = Math.max(0, Math.min(6, parseInt((totalEls[i] && totalEls[i].value) || 0, 10)));
                    const p_attach = baseAttach * Math.pow(1.1, tot);
                    const pStar = probFromCond(dist, (starEls[i] && starEls[i].value) || 'ge1');
                    const p_success = p_attach * pStar;
                    p_white_skill *= p_success;
                }

                /* ----- WHITE (éºä¼å­) ----- */
                const geneTargetEls = Array.from(document.getElementsByClassName('whiteGeneTarget'));
                const geneSumEls = Array.from(document.getElementsByClassName('whiteGeneSum'));
                const geneStarEls = Array.from(document.getElementsByClassName('whiteGeneStarCond'));

                p_white_gene = 1.0;
                for (let i = 0; i < geneTargetEls.length; i++) {
                    const sumSel = (geneSumEls[i] && geneSumEls[i].value) || '0-5';
                    let p_attach = 0.0;
                    if (sumSel === '0-5') p_attach = 0.0;
                    else if (sumSel === '6-11') p_attach = 0.4;
                    else if (sumSel === '12-18') p_attach = 1.0;
                    const pStar = probFromCond(redStarDist, (geneStarEls[i] && geneStarEls[i].value) || 'ge1');
                    const p_success = p_attach * pStar;
                    p_white_gene *= p_success;
                }
            }

            /* ----- Joint probability(1è©¦è¡Œã‚ãŸã‚Š) ----- */
            let p_joint = 1.0;
            if (enableBlue) p_joint *= p_blue;
            if (enableRed) p_joint *= p_red;
            if (enableGreen) p_joint *= p_green;
            if (enableWhite) p_joint *= (p_white_skill * p_white_gene);
            if (!enableBlue && !enableRed && !enableGreen && !enableWhite) p_joint = 0;

            /* ----- å¿…è¦è©¦è¡Œå›æ•°ã¨æ—¥æ•°ã®è¨ˆç®— ----- */
            let requiredTrials, requiredDays;
            if (p_joint <= 0) {
                requiredTrials = Infinity;
                requiredDays = Infinity;
            } else if (p_joint >= 1.0) {
                requiredTrials = 1;
                requiredDays = Math.ceil(1 / (Math.max(1, parseInt(document.getElementById('numPerDay').value || 1, 10)) * Math.min(3, Math.max(1, parseInt(document.getElementById('numRerolls').value || 1, 10)))));
            } else {
                const rawTrials = Math.log(1 - T) / Math.log(1 - p_joint);
                requiredTrials = Math.max(0, Math.ceil(rawTrials));
                requiredDays = Math.ceil(requiredTrials / trialsPerDay);
            }

            /* ----- ã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆè©•ä¾¡ ----- */
            let deadlineText = '(ã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆæœªæŒ‡å®š)';
            const deadlineVal = document.getElementById('deadlineDate').value;
            if (deadlineVal) {
                const today = new Date();
                const deadline = new Date(deadlineVal + 'T00:00:00');
                const diffMs = deadline - new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                if (diffDays < 0) {
                    deadlineText = 'ã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆã¯éå»æ—¥ä»˜ã§ã™';
                } else {
                    const totalTrialsAvailable = diffDays * trialsPerDay;
                    const probByDeadline = 1 - Math.pow(1 - p_joint, totalTrialsAvailable);
                    deadlineText = `æ®‹ã‚Š ${diffDays} æ—¥ (è¨ˆ ${totalTrialsAvailable} å›æŠ½é¸) ã§å®Œæˆã™ã‚‹ç¢ºç‡: ${(probByDeadline * 100).toFixed(6)} %`;
                }
            }

            /* ----- å‡ºåŠ›æ•´å½¢ ----- */
            document.getElementById('resultCard').style.display = 'block';
            const lines = [];
            lines.push('=== 1è©¦è¡Œã‚ãŸã‚Šã®åŒæ™‚æˆç«‹ç¢ºç‡(æœ‰åŠ¹ãªå› å­ã™ã¹ã¦ãŒæˆç«‹) ===');
            lines.push((p_joint * 100).toFixed(8) + ' %');
            lines.push('');
            lines.push(`=== ç›®æ¨™ç¢ºç‡ ${(Math.min(99, Math.max(1, parseInt(document.getElementById('targetProb').value || 90, 10))))}% ã«é”ã™ã‚‹ã¾ã§ã®å¿…è¦è©¦è¡Œå›æ•°ãƒ»æ—¥æ•° ===`);
            if (requiredTrials === Infinity) {
                lines.push('åˆ°é”ä¸å¯(1è©¦è¡Œã‚ãŸã‚Šã®åŒæ™‚æˆç«‹ç¢ºç‡ãŒ 0 ã®ãŸã‚)');
            } else {
                lines.push('ç·è©¦è¡Œæ•°(æŠ½é¸å›æ•°): ' + requiredTrials + ' å›');
                lines.push('å¿…è¦ãªæ—¥æ•°(1æ—¥ã‚ãŸã‚Š ' + trialsPerDay + ' æŠ½é¸ã¨ã—ã¦): ' + requiredDays + ' æ—¥');
                lines.push('');
            }
            lines.push('=== ã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆè©•ä¾¡ ===');
            lines.push(deadlineText);
            lines.push('');
            lines.push('--- å†…è¨³(1è©¦è¡Œã‚ãŸã‚Šç¢ºç‡) ---');
            if (enableBlue) lines.push('é’å› å­: ' + (p_blue * 100).toFixed(8) + ' %');
            if (enableRed) lines.push('èµ¤å› å­: ' + (p_red * 100).toFixed(8) + ' %');
            if (enableGreen) lines.push('ç·‘å› å­: ' + (p_green * 100).toFixed(8) + ' %');
            if (enableWhite) {
                lines.push('ç™½å› å­(ã‚¹ã‚­ãƒ«/ãƒ¬ãƒ¼ã‚¹ãƒ»å…¨ä½“): ' + (p_white_skill * 100).toFixed(8) + ' %');
                lines.push('ç™½å› å­(éºä¼å­ãƒ»å…¨ä½“): ' + (p_white_gene * 100).toFixed(8) + ' %');
            }

            lines.push('\n--- æ³¨æ„ ---');
            lines.push('â€¢ æ•°å€¤ã¯æœ‰å¿—æ¨å®šã‹ã‚‰ä»®å®šã—ãŸãƒ¢ãƒ‡ãƒ«ã«åŸºã¥ãã¾ã™ã€‚å…¬å¼å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
            lines.push('â€¢ ç™½å› å­ã®ä»˜ä¸ãƒ¢ãƒ‡ãƒ«: åŸºç¤ç¢ºç‡ã¯ é€šå¸¸20% / â—25% / é‡‘40%ã€‚è¦ªã‚„ç¥–ãŒåŒã˜å› å­ã‚’æŒã¤ã”ã¨ã« Ã—1.1^n ã§è£œæ­£ã€‚');

            document.getElementById('resultText').textContent = lines.join('\n');

            // å…¥åŠ›çŠ¶æ…‹ã‚’ä¿å­˜
            saveInputsToStorage();

            // çµæœã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /* =========================
           ã‚«ãƒ¼ãƒ‰ã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ—¢å­˜ï¼‰ã¨ãƒ­ãƒƒã‚¯è¡¨ç¤º
           ========================= */
        function setCardEnabled(cardId, enabled) {
            const card = document.getElementById(cardId);
            if (!card) return;
            card.classList.toggle('disabled', !enabled);
            const inputs = card.querySelectorAll('input, select, button');
            inputs.forEach(el => {
                if (el.id === 'addWhiteSkillBtn' || el.id === 'addWhiteGeneBtn') { el.disabled = !enabled; return; }
                if (el.id === 'compute') return;
                el.disabled = !enabled;
            });
        }
        function updateCardStates() {
            setCardEnabled('blueCard', document.getElementById('enableBlue').checked);
            setCardEnabled('redCard', document.getElementById('enableRed').checked);
            setCardEnabled('greenCard', document.getElementById('enableGreen').checked);
            setCardEnabled('whiteCard', document.getElementById('enableWhite').checked);
        }
        ['enableBlue', 'enableRed', 'enableGreen', 'enableWhite'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', updateCardStates);
        });

        const baseBlueTitle = document.getElementById('blueTitle').textContent;
        const baseRedTitle = document.getElementById('redTitle').textContent;
        function updateLockIcons() {
            const p = document.getElementById('pathType').value;
            const blueTitleEl = document.getElementById('blueTitle');
            const redTitleEl = document.getElementById('redTitle');
            blueTitleEl.textContent = baseBlueTitle;
            redTitleEl.textContent = baseRedTitle;
            if (p === 'blue') blueTitleEl.textContent = 'ğŸ”’ ' + baseBlueTitle;
            if (p === 'red') redTitleEl.textContent = 'ğŸ”’ ' + baseRedTitle;
        }
        document.getElementById('pathType').addEventListener('change', updateLockIcons);

        /* =========================
           ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿å­˜ãƒãƒ³ãƒ‰ãƒ©ï¼ˆ1å›ã ã‘ç™»éŒ²ï¼‰
           ========================= */
        function attachGlobalSaveHandlers() {
            const els = document.querySelectorAll('input[id], select[id], textarea[id]');
            els.forEach(el => {
                el.removeEventListener('input', saveInputsToStorage);
                el.removeEventListener('change', saveInputsToStorage);
                el.addEventListener('input', saveInputsToStorage);
                el.addEventListener('change', saveInputsToStorage);
            });

            ['enableBlue', 'enableRed', 'enableGreen', 'enableWhite'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.removeEventListener('change', updateCardStates);
                el.addEventListener('change', () => {
                    updateCardStates();
                    saveInputsToStorage();
                });
            });

            const pathEl = document.getElementById('pathType');
            if (pathEl) {
                pathEl.removeEventListener('change', updateLockIcons);
                pathEl.addEventListener('change', () => {
                    updateLockIcons();
                    saveInputsToStorage();
                });
            }
        }

        /* =========================
           åˆæœŸåŒ–ï¼šå¾©å…ƒãƒ»ãƒãƒ³ãƒ‰ãƒ©å–ã‚Šä»˜ã‘ï¼ˆé‡è¤‡ç™»éŒ²å›é¿ï¼‰
           ========================= */
        window.addEventListener('DOMContentLoaded', () => {
            const data = loadInputsFromStorage();
            restoreDynamicWhiteFromStorage(data);
            updateCardStates();
            updateLockIcons();
            attachGlobalSaveHandlers();

            // add-button ã¯ã“ã“ã§ä¸€åº¦ã ã‘ç™»éŒ²
            const addSkillBtn = document.getElementById('addWhiteSkillBtn');
            if (addSkillBtn) {
                addSkillBtn.removeEventListener('click', addWhiteSkillRow);
                addSkillBtn.addEventListener('click', () => addWhiteSkillRow());
            }
            const addGeneBtn = document.getElementById('addWhiteGeneBtn');
            if (addGeneBtn) {
                addGeneBtn.removeEventListener('click', addWhiteGeneRow);
                addGeneBtn.addEventListener('click', () => addWhiteGeneRow());
            }

            // compute ãƒœã‚¿ãƒ³
            const computeBtn = document.getElementById('compute');
            if (computeBtn) {
                computeBtn.removeEventListener('click', computeHandler);
                computeBtn.addEventListener('click', computeHandler);
            }

            // update add button states
            updateAddButtonsState();
        });
    </script>
</body>


</html>

